<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自动排座系统（增强版）</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 15px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .area-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .area-input {
            flex: 1;
        }
        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>自动排座系统（增强版）</h1>
        
        <div class="instructions">
            <h3>使用说明：</h3>
            <ol>
                <li>在下方文本框中输入名单（可带序号或不带序号）</li>
                <li>选择左右区域的列数（8列或9列）</li>
                <li>设置左、中、右三个区域的序号范围（如：1-30）</li>
                <li>可选：填写不来人员名单和固定座位安排</li>
                <li>点击"生成排座表"按钮</li>
                <li>系统将自动下载Excel排座表</li>
            </ol>
            <p><strong>✅ 已实现的功能：</strong></p>
            <ul>
                <li>✅ 主席台和校领导单元格自动合并</li>
                <li>✅ 主席台背景设置为灰色</li>
                <li>✅ 左中右三个区域自动添加边框</li>
                <li>✅ 统一设置列宽8.04和行高15.95</li>
                <li>✅ 所有文字使用仿宋_GB2312字体，12号大小</li>
                <li>✅ 所有内容居中对齐显示</li>
                <li>✅ 左右区域列数选择（8列/9列）</li>
                <li>✅ 不来人员自动跳过</li>
                <li>✅ 固定座位安排</li>
            </ul>
            <p><strong>技术说明：</strong>使用 xlsx-js-style 库替代原生xlsx库，完美支持Excel样式设置</p>
        </div>
        
        <div class="input-group">
            <label for="nameList">名单输入（每行一个名字，可带序号或不带序号）：</label>
            <textarea id="nameList" placeholder="例如：
1 张三
2 李四
王五
赵六"></textarea>
        </div>
        
        <div class="input-group">
            <label for="columnMode">左右区域列数选择：</label>
            <select id="columnMode">
                <option value="9">9列（B列和U列正常排座）</option>
                <option value="8">8列（B列和U列不排座）</option>
            </select>
        </div>
        
        <div class="area-inputs">
            <div class="area-input">
                <label for="leftArea">左边区域序号范围（如：31-60）：</label>
                <input type="text" id="leftArea" placeholder="31-60">
            </div>
            <div class="area-input">
                <label for="centerArea">中间区域序号范围（如：1-30）：</label>
                <input type="text" id="centerArea" placeholder="1-30">
            </div>
            <div class="area-input">
                <label for="rightArea">右边区域序号范围（如：61-90）：</label>
                <input type="text" id="rightArea" placeholder="61-90">
            </div>
        </div>
        
        <div class="input-group">
            <label for="absentList">不来人员名单（每行一个，格式：序号 姓名）：</label>
            <textarea id="absentList" placeholder="例如：
5 张三
12 李四"></textarea>
        </div>
        
        <div class="input-group">
            <label for="fixedSeats">固定座位安排（每行一个，格式：序号 姓名 座位）：</label>
            <textarea id="fixedSeats" placeholder="例如：
11 陈小飞 N7
25 王五 C5"></textarea>
        </div>
        
        <button id="generateBtn">生成排座表</button>
    </div>

    <script>
        document.getElementById('generateBtn').addEventListener('click', generateSeatingChart);
        
        function generateSeatingChart() {
            const nameListText = document.getElementById('nameList').value.trim();
            const columnMode = document.getElementById('columnMode').value;
            const leftRange = document.getElementById('leftArea').value.trim();
            const centerRange = document.getElementById('centerArea').value.trim();
            const rightRange = document.getElementById('rightArea').value.trim();
            const absentListText = document.getElementById('absentList').value.trim();
            const fixedSeatsText = document.getElementById('fixedSeats').value.trim();
            
            const nameList = parseNameList(nameListText);
            if (!nameList) {
                alert('名单解析失败，请检查输入格式');
                return;
            }
            
            const leftRangeNumbers = parseRange(leftRange);
            const centerRangeNumbers = parseRange(centerRange);
            const rightRangeNumbers = parseRange(rightRange);
            
            if (!leftRangeNumbers || !centerRangeNumbers || !rightRangeNumbers) {
                alert('区域范围格式不正确，请使用如"1-30"的格式');
                return;
            }
            
            const absentList = parseAbsentList(absentListText);
            const fixedSeats = parseFixedSeats(fixedSeatsText);
            
            const wb = XLSX.utils.book_new();
            const wsData = createWorksheetData(nameList, leftRangeNumbers, centerRangeNumbers, rightRangeNumbers, columnMode, absentList, fixedSeats);
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            setWorksheetProperties(ws, columnMode);
            
            XLSX.utils.book_append_sheet(wb, ws, "排座表");
            XLSX.writeFile(wb, "排座表.xlsx", {cellStyles: true});
        }
        
        function parseNameList(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const matchWithNumber = line.match(/^(\d+)[\s\t]+(.+)$/);
                
                if (matchWithNumber) {
                    const number = parseInt(matchWithNumber[1]);
                    const name = matchWithNumber[2].trim();
                    result.push({ number, name });
                } else {
                    result.push({ number: i + 1, name: line });
                }
            }
            
            return result.length > 0 ? result : null;
        }
        
        function parseRange(rangeStr) {
            const match = rangeStr.match(/^(\d+)\s*-\s*(\d+)$/);
            if (!match) return null;
            
            const start = parseInt(match[1]);
            const end = parseInt(match[2]);
            
            if (start > end) return null;
            
            return { start, end };
        }
        
        function parseAbsentList(text) {
            if (!text) return [];
            
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const result = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                const match = trimmed.match(/^(\d+)[\s\t]+(.+)$/);
                
                if (match) {
                    const number = parseInt(match[1]);
                    const name = match[2].trim();
                    result.push({ number, name });
                }
            }
            
            return result;
        }
        
        function parseFixedSeats(text) {
            if (!text) return [];
            
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const result = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                const match = trimmed.match(/^(\d+)[\s\t]+(.+?)[\s\t]+([A-Z]+\d+)$/);
                
                if (match) {
                    const number = parseInt(match[1]);
                    const name = match[2].trim();
                    const seat = match[3].trim().toUpperCase();
                    result.push({ number, name, seat });
                }
            }
            
            return result;
        }
        
        function seatToPosition(seat) {
            // 将座位字符串（如N7）转换为行列坐标
            const match = seat.match(/^([A-Z]+)(\d+)$/);
            if (!match) return null;
            
            const colStr = match[1];
            const rowNum = parseInt(match[2]);
            
            // 将列字母转换为列索引（A=0, B=1, ...）
            let col = 0;
            for (let i = 0; i < colStr.length; i++) {
                col = col * 26 + (colStr.charCodeAt(i) - 65 + 1);
            }
            col--; // 转换为0索引
            
            const row = rowNum - 1; // 转换为0索引
            
            // 检查坐标是否在有效范围内
            if (row < 0 || row >= 16 || col < 0 || col >= 29) {
                return null;
            }
            
            return { row, col };
        }
        
        function createWorksheetData(nameList, leftRange, centerRange, rightRange, columnMode, absentList, fixedSeats) {
            const rows = 16;
            const cols = 29;
            const wsData = Array(rows).fill().map(() => Array(cols).fill(''));
            
            wsData[0][13] = "主席台";
            
            const columnNumbers = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26];
            for (let i = 0; i < columnNumbers.length; i++) {
                const col = i < 9 ? i + 1 : i + 2;
                wsData[2][col] = columnNumbers[i];
            }
            
            for (let i = 0; i < 12; i++) {
                wsData[i + 4][0] = `${i + 1}排`;
            }
            
            wsData[4][11] = "校领导";
            
            // 先处理固定座位
            const occupiedSeats = new Set();
            const fixedSeatNumbers = new Set(); // 新增：记录已固定座位的人员序号
            for (const fixedSeat of fixedSeats) {
                const position = seatToPosition(fixedSeat.seat);
                if (position) {
                    wsData[position.row][position.col] = fixedSeat.name;
                    occupiedSeats.add(`${position.row},${position.col}`);
                    fixedSeatNumbers.add(fixedSeat.number); // 记录固定座位人员的序号
                }
            }
            
            // 创建不来人员的序号集合
            const absentNumbers = new Set(absentList.map(item => item.number));
            
            assignSeats(wsData, nameList, leftRange, 'left', columnMode, absentNumbers, occupiedSeats, fixedSeatNumbers);
            assignSeats(wsData, nameList, centerRange, 'center', columnMode, absentNumbers, occupiedSeats, fixedSeatNumbers);
            assignSeats(wsData, nameList, rightRange, 'right', columnMode, absentNumbers, occupiedSeats, fixedSeatNumbers);
            
            return wsData;
        }
        
        function assignSeats(wsData, nameList, range, area, columnMode, absentNumbers, occupiedSeats, fixedSeatNumbers) {
            // 过滤出当前区域的人员，排除不来的人员和已固定座位的人员
            const areaNames = nameList
                .filter(item => item.number >= range.start && item.number <= range.end)
                .filter(item => !absentNumbers.has(item.number))
                .filter(item => !fixedSeatNumbers.has(item.number)) // 新增：排除已固定座位的人员
                .sort((a, b) => a.number - b.number);
            
            let startRow, startCol, cols;
            
            if (area === 'left') {
                startRow = 4;
                startCol = columnMode === '9' ? 1 : 2; // 9列模式从B列开始，8列模式从C列开始
                cols = columnMode === '9' ? 9 : 8;
            } else if (area === 'center') {
                startRow = 5;
                startCol = 11;
                cols = 8; // 中间区域始终是8列
            } else {
                startRow = 4;
                startCol = columnMode === '9' ? 20 : 21; // 9列模式从U列开始，8列模式从V列开始
                cols = columnMode === '9' ? 9 : 8;
            }
            
            let index = 0;
            for (let row = startRow; row < startRow + 12 && index < areaNames.length; row++) {
                for (let col = startCol; col < startCol + cols && index < areaNames.length; col++) {
                    // 跳过已被固定座位占用的位置
                    if (occupiedSeats.has(`${row},${col}`)) {
                        continue;
                    }
                    
                    wsData[row][col] = areaNames[index].name;
                    index++;
                }
            }
        }
        
        function setWorksheetProperties(ws, columnMode) {
            // 设置列宽 - 所有列都设置为8.04字符宽度
            ws['!cols'] = Array(29).fill().map(() => ({wch: 8.04}));
            
            // 设置行高 - 所有行都设置为25磅
            ws['!rows'] = Array(16).fill().map(() => ({hpt: 25}));
            
            // 合并单元格
            ws['!merges'] = [
                {s: {r: 0, c: 13}, e: {r: 1, c: 16}}, // 主席台合并 N1:Q2
                {s: {r: 4, c: 11}, e: {r: 4, c: 18}}  // 校领导合并 L5:S5
            ];
            
            // 设置所有单元格的默认样式
            setupAllCellStyles(ws, columnMode);
        }
        
        function setupAllCellStyles(ws, columnMode) {
            // 定义默认样式
            const defaultFont = {name: "仿宋_GB2312", sz: 12};
            const centerAlignment = {horizontal: "center", vertical: "center"};
            const borderStyle = {
                top: {style: "thin", color: {auto: 1}},
                bottom: {style: "thin", color: {auto: 1}},
                left: {style: "thin", color: {auto: 1}},
                right: {style: "thin", color: {auto: 1}}
            };
            
            // 遍历所有单元格（16行x29列）
            for (let r = 0; r < 16; r++) {
                for (let c = 0; c < 29; c++) {
                    const cellRef = XLSX.utils.encode_cell({r, c});
                    
                    // 确保单元格存在
                    if (!ws[cellRef]) {
                        ws[cellRef] = {v: "", t: "s"};
                    }
                    
                    // 初始化样式对象
                    if (!ws[cellRef].s) {
                        ws[cellRef].s = {};
                    }
                    
                    // 设置基础样式：字体和对齐
                    ws[cellRef].s.font = defaultFont;
                    ws[cellRef].s.alignment = centerAlignment;
                }
            }
            
            // 1. 设置主席台样式（N1，灰色背景+粗体）
            const presidiumCell = 'N1';
            ws[presidiumCell].v = "主席台";
            ws[presidiumCell].t = "s";
            ws[presidiumCell].s = {
                fill: {patternType: "solid", fgColor: {rgb: "D3D3D3"}},
                alignment: centerAlignment,
                font: {name: "仿宋_GB2312", sz: 12, bold: true}
            };
            
            // 2. 设置校领导样式（L5，粗体）
            const leaderCell = 'L5';
            ws[leaderCell].v = "校领导";
            ws[leaderCell].t = "s";
            ws[leaderCell].s = {
                alignment: centerAlignment,
                font: {name: "仿宋_GB2312", sz: 12, bold: true}
            };
            
            // 3. 设置列序号样式（粗体）
            const columnNumbers = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26];
            for (let i = 0; i < columnNumbers.length; i++) {
                const col = i < 9 ? i + 1 : i + 2;
                const cellRef = XLSX.utils.encode_cell({r: 2, c: col});
                ws[cellRef].v = columnNumbers[i];
                ws[cellRef].t = "n";
                ws[cellRef].s = {
                    alignment: centerAlignment,
                    font: {name: "仿宋_GB2312", sz: 12, bold: true}
                };
            }
            
            // 4. 设置行序号样式（粗体）
            for (let i = 0; i < 12; i++) {
                const cellRef = XLSX.utils.encode_cell({r: i + 4, c: 0});
                ws[cellRef].v = `${i + 1}排`;
                ws[cellRef].t = "s";
                ws[cellRef].s = {
                    alignment: centerAlignment,
                    font: {name: "仿宋_GB2312", sz: 12, bold: true}
                };
            }
            
            // 5. 为校领导区域添加边框（L5:S5）
            addBorderToArea(ws, 4, 11, 4, 18, borderStyle); // 校领导区域 L5:S5
            
            // 6. 为三个排座区域添加边框（根据列数模式调整）
            if (columnMode === '9') {
                addBorderToArea(ws, 4, 1, 15, 9, borderStyle);   // 左边区域 B5:J16 (9列)
                addBorderToArea(ws, 4, 20, 15, 28, borderStyle); // 右边区域 U5:AC16 (9列)
            } else {
                addBorderToArea(ws, 4, 2, 15, 9, borderStyle);   // 左边区域 C5:J16 (8列)
                addBorderToArea(ws, 4, 21, 15, 28, borderStyle); // 右边区域 V5:AC16 (8列)
            }
            addBorderToArea(ws, 5, 11, 15, 18, borderStyle); // 中间区域 L6:S16 (始终8列)
        }
        
        function addBorderToArea(ws, startRow, startCol, endRow, endCol, borderStyle) {
            for (let r = startRow; r <= endRow; r++) {
                for (let c = startCol; c <= endCol; c++) {
                    const cellRef = XLSX.utils.encode_cell({r, c});
                    
                    // 确保单元格存在并有样式对象
                    if (!ws[cellRef]) {
                        ws[cellRef] = {v: "", t: "s"};
                    }
                    if (!ws[cellRef].s) {
                        ws[cellRef].s = {};
                    }
                    
                    // 设置边框，保留原有样式
                    ws[cellRef].s = {
                        ...ws[cellRef].s,
                        border: borderStyle
                    };
                }
            }
        }
    </script>
</body>
</html> 
